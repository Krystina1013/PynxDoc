# 前言
当通过了transp2p实现了可路由的数据发送后，我们可以设计实现组播，组播有两种方式，目前系统支持预定义组播和有源（种子）组播两种模式：
* 预定义组播：节点自身根据某种算法计算得知属于某一组，在这种组播方式内，所有的节点都是平等的。
* 有源组播：某个组具有一组（一个或多个源节点），是组的起始节点，所有其他可以路由到这些节点的节点可能会加入该组。在有源组播中，具有多个角色，组发起者、数据源、组管理者，中继节点，客户端。
显而易见的，有源组播与应用业务更加相关，因此在本章中，仅讨论预定义组播，有源组播在相应的应用模块设计中描述。因此，本章中，若非特别指明，组播是指预定义组播。

# 服务公告
当节点加入某个组时，需要向全网节点广播此消息，这个广播的过程称为服务公告。当节点离开某个组时，需要通知全网自身已经离开。由于节点离开的不确定性（比如说网络继开了，节点宕机了），因此无法采用离开前向全网公告自身离开的方案。因此采用了在重复广播/超时的方案：当节点在提供服务时，定时向全网发送服务公告，如果全网一段时间没有收到服务公告，就认为该节点已经失效。  
在重复广播/超时方案中，为了防止节点通过广播公告消息实现网络攻击，我们作以下的约定：
1. 同一节点的同一服务广播公告消息，每10分钟只许一次，如果收另外一个节点的10分钟以内的同一服务多个公告消息，只保留最新的一个，并且延时到10分钟以后再发送。
2. 同一节点同时只允许提供20个服务，当20个服务满了，其他节点收到新的服务消息，将不再转发。
# 服务节点获取
同分组的节点需要互相连接，至少需要互相知道，因此，需要从网络中获取某个分组的服务节点，这些节点通过节点获取实现。  
由于分组内的节点是动态的，因此分组需要定时轮询，从而获取提供该分组服务的节点。在应用设计中，控制一个分组的节点在1K到10K个之间，为了使路由层次不要过深，我们将分组间连接数控制在32左右，这样平均扇数为16，网络传输时的平均跳数为3-4。

# 网络连接
当节点发现提供同一服务的节点时，尝试与这些节点进行网络连接，直到有足够多的网络连接（32个），如果没有足够多的网络,节点会定时读取服务节点，并且根据结果连接。